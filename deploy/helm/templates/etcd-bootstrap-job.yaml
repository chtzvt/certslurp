apiVersion: batch/v1
kind: Job
metadata:
  name: etcd-bootstrap-user
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: etcd-bootstrap-user
          image: {{ .Values.etcd.image }} 
          env:
            - name: ETCD_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: etcd-root-secret
                  key: root-password
            - name: CERTSLURPD_USERNAME
              valueFrom:
                secretKeyRef:
                  name: certslurpd-etcd-creds
                  key: username
            - name: CERTSLURPD_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: certslurpd-etcd-creds
                  key: password
            - name: ETCD_ENDPOINTS
              value: "http://etcd-0.etcd-headless.default.svc.cluster.local:2379,http://etcd-1.etcd-headless.default.svc.cluster.local:2379,http://etcd-2.etcd-headless.default.svc.cluster.local:2379"
          command:
            - /bin/bash
            - -c
            - |
                set -e

                # Split ETCD_ENDPOINTS on comma into an array
                IFS=',' read -ra ENDPOINTS <<< "$ETCD_ENDPOINTS"

                echo "Waiting for all etcd endpoints to be healthy..."
                for endpoint in "${ENDPOINTS[@]}"; do
                  echo "Checking $endpoint"
                  until etcdctl --user root:"$ETCD_ROOT_PASSWORD" --endpoints "$endpoint" endpoint health; do
                    echo "  $endpoint not healthy yet, waiting..."
                    sleep 2
                  done
                  echo "  $endpoint is healthy"
                done

                echo "All endpoints healthy, bootstrapping etcd user/role"

                etcdctl --user root:"$ETCD_ROOT_PASSWORD" --endpoints "$ETCD_ENDPOINTS" user add "$CERTSLURPD_USERNAME" --new-user-password="$CERTSLURPD_PASSWORD" || true
                etcdctl --user root:"$ETCD_ROOT_PASSWORD" --endpoints "$ETCD_ENDPOINTS" role add certslurpd_role || true
                etcdctl --user root:"$ETCD_ROOT_PASSWORD" --endpoints "$ETCD_ENDPOINTS" user grant-role "$CERTSLURPD_USERNAME" certslurpd_role || true
                etcdctl --user root:"$ETCD_ROOT_PASSWORD" --endpoints "$ETCD_ENDPOINTS" role grant-permission certslurpd_role --prefix=true readwrite / || true
                etcdctl --user root:"$ETCD_ROOT_PASSWORD" --endpoints "$ETCD_ENDPOINTS" auth enable || true
                echo "Done"